---
output: github_document
---

```{r setup, include=FALSE}
options(scipen = 10000000)
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.path = "figures/",
  out.width = "100%",
  fig.retina = 2,
  echo = FALSE
)
```


# Visualizing the Corona (COVID-19) pandemic

## Basic idea

I generally think that the news do a good job in describing and visualizing the corona pandemic. However, there are two things that I believe are quite problematic and that I am missing the any news coverage on the pandemic. 

1. Visualizations of the growth curves often log-transform the x-axis instead of showing or at least comparing it with the actual *exponential* growth.
2. Visualizations almost never plot *total* cases against a) deaths, b) recovered, AND c) active cases. 

With regard to the former, I recently wrote [this blogpost](http://philippmasur.de/blog/2020/03/13/understanding-exponential-growth-the-corona-pandemic/) that explains why exponential growth is so hard to grasp. With regard to the latter, I believe that visualizations would become a bit more informative if we plot total cases, active cases, recovered cases, and deaths. If we plot all *four* curves simultaneously, patterns emerge that might tell us something about the "phase"" that a country is it. We may also see whether a country succeeds in stopping the infections (BUT: see disclaimer further below!). In what follows, I am using the data on worldwide total infections, death rates, and number of recoveries to produce these (potentially) a bit more insightful visualizations. 

#### Where does the data come frome?

The analyses and visualizations are based on the data provided by the John Hopkins University in the [Official 2019 Novel Coronavirus COVID-19 (2019-nCoV) Data Repository](https://github.com/CSSEGISandData/COVID-19). The same data sets are used to constantly update this visual dashboard: https://coronavirus.jhu.edu/map.html

**IMPORTANT DISCLAIMER:**
Although I do believe that these data help us to understand the pandemic, they are nonetheless very imprecise. When we want to make sense of positive test results (i.e., total cases and in the long run mortality rates and recovering processes), we need to know how many tests were conducted. South Korea, for example, has tested > 270,000 people, which amounts to more than 5,200 tests per million inhabitants. The numbers in South Korea are hence more trustworthy than the numbers of all other countries. A high diagnostic capacity at scale is hence key to epidemic control as it provides us with precise estimates and growth rate predictions (for more information on this, see [this article](https://www.sciencemag.org/news/2020/03/coronavirus-cases-have-dropped-sharply-south-korea-whats-secret-its-success?fbclid=IwAR3BnhqQMxCdu8-fQelEkWIDQn-j9UASV773Xl-WbIy8l7M5ZVSQpHFgkL8) in Science). For this reasons, I believe that the value of these visualization lies NOT in comparing the actual numbers, but in understanding the patterns that emerge by comparing all four curves. 

Furthermore, I would like to emphasize that I am not an expert on epidemology or virus outbreaks and I am not working in the health sector. On this page, I am only visualizing the data by the John Hopkins University in a different way that most news or other outlets do. Reliance on the these visualizations for medical guidance or use of these visualization in commerce is strictly prohibited.

#### Will these figures be updated?

The last update was made on `r Sys.time()`. The data of the John Hopkins University, however, are always updated at 23:59. What you see is hence the situation on `r Sys.Date()-1` at 23:59:00. Also bear in mind that the reporting of cases is somewhat delayed so that it is very likely that the actual numbers are higher.

## Visualizations

If you are interested in the R code, please see the [README.rmd](https://github.com/masurp/corona_analyses/blob/master/README.rmd). 

```{r, message = F, warning = F}
library(tidycovid19)
library(tidyverse)
library(lubridate)
library(see)

# Function to plot figures
plot_graph <- function(data, size = .75){
  ggplot(data, aes(x = days, y = value, color = key)) +
  geom_line(size = size) +
  scale_color_manual(values = c("#cc0000", "#ff8000", "#1d1d63", "#00b359")) +
  facet_wrap(~country, scale = "free_y") +
  theme_modern() +
  labs(x = "days after 100 cases", y = "cases", color = "")
}

# Get & wrangle data ####
data <- download_jhu_csse_covid19_data() 

data <- data %>%
  select(-iso3c, -timestamp) %>%
  mutate(active = confirmed - (deaths + recovered))

```

### 1. Examplary patterns

```{r, results='asis', message=F, warning=F}
highest <- c("US", "Russia", "United Kingdom", "Italy", "Germany", "China", "Brazil", "Spain", "India")


data %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate("new_cases" = confirmed - lag(confirmed)) %>%
  ungroup %>%
  filter(country %in% highest) %>%
  filter(date == Sys.Date()-1) %>%
  arrange(desc(confirmed)) %>%
  papaja::apa_table(., 
                    align = c("l", "c", rep("r", 5)))
```

```{r, fig.height=10.5, fig.width=14, message=F, warning=F}
data %>%
  filter(confirmed >= 100) %>%
  filter(country %in% highest) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  gather(key, value, -country, -date, -days) %>%
  plot_graph

ggsave("figures/plot_1.png",
       width = 14,
       height = 10.5)
```


### 2. Worldwide developments

#### Europe

```{r europe}
europe <- c("Italy", "Spain", "Germany", "France", 
            "Switzerland", "United Kingdom", "Netherlands", 
            "Norway", "Austria", "Sweden", "Belgium", "Denmark",
            "Portugal", "Czechia", "Ireland", "Turkey",
            "Ireland", "Poland", "Romania", "Czechia",
            "Serbia", "Ukraine")
``` 

```{r europe_plot, fig.height=9, fig.width = 14}
data %>%
  filter(confirmed >= 100) %>%
  filter(country %in% europe) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  gather(key, value, -country, -date, -days) %>%
  plot_graph(size = .6) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("figures/plot_3.png",
       width = 9,
       height = 14)
```

#### North, Middle and South America

```{r}
america <- c("US", "Canada", "Brazil", "Chile",
             "Argentina", "Uruguay", "Mexico", "Peru",
             "Panama", "Dominican Republic", "Colombia", "Bolivia")
```  

```{r northamerica, fig.height=7, fig.width = 11.5}
data %>%
  filter(confirmed >= 100) %>%
  filter(country %in% america) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  gather(key, value, -country, -date, -days) %>%
  plot_graph

ggsave("figures/plot_4.png",
       width = 11.5,
       height = 7)
```

#### Middle East

```{r}
middleeast <- c("Iran", "Qatar", "Saudi Arabia", "Qatar",
                "Israel", "Pakistan", "United Arab Emirates")
```  

```{r middleeast, fig.height=5, fig.width = 9}
data %>%
  filter(confirmed >=100) %>%
  filter(country %in% middleeast) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  gather(key, value, -country, -date, -days) %>%
  plot_graph

ggsave("figures/plot_5.png",
       width = 5,
       height = 9)
```

#### Asia, Indonesia, Australia

```{r}
asia <- c("China", "Korea, South", "Japan", 
          "Malaysia", "Russia", "India", "Australia",
          "Philippines", "Thailand", "Laos", "Indonesia", "Singapore",
          "Bangladesh")
```

```{r asia, fig.height=7, fig.width = 11.5}
data %>%
  filter(confirmed >= 100) %>%
  filter(country %in% asia) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  gather(key, value, -country, -date, -days) %>%
  plot_graph

ggsave("figures/plot_6.png",
       width = 11.5,
       height = 7)
```

#### Africa


```{r}
africa <- c("South Africa", "Egypt", "Algeria", "Morocco", "Ghana", "Nigeria")
```

```{r africa, fig.height=5, fig.width = 9}
data %>%
  filter(confirmed >= 100) %>%
  filter(country %in% africa) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  gather(key, value, -country, -date, -days) %>%
  plot_graph

ggsave("figures/plot_7.png",
       width = 9,
       height = 5)
```


### 3. Alternative visualizations


### Total cases

One thing that is constantly debatted is how to visualize the growth of total confirmed cases at all. Log-transform the y-axis or not? Plot against the date? Plot against days after 100th case? Plot something entirely different?

Here, I would like to explain some differences between visualizations that have been used in the media or on Twitter. All of them are helpful in their own regard. 

1. LEFT: Here, I plotted total cases against days after the 100th cases *without* logarithmizing the y-axis. 

2. MIDDLE: The y-axis is logarithmized. This figure is often shown in the news. 

3. RIGHT: New cases per 7 days (y-axis) are plotted against total cases (x-axis), both axes are logarithmized (Idea explained in this [video](https://www.youtube.com/watch?v=54XLXg4fYsc)). 

We see clearly that each plot has benefits and weaknesses. The first example provides perhaps the best comparison of the total numbers and shows quite drastically how exponential growth curves look likes (bear in mind that I cut off the growth curve of the US, which actually extends to more than 1,5 million cases. I did this to make the other growth curves visible). S-curves represent positive developments towards a slower growth. Yet, changes are barely identifiable. 

The second example makes the actual growth more comparable and by logarithmizing the y-axsis, we can actually see changes in the growth. Here, it seems that most countries are actually starting to slow the growth. Yet, the huge difference between e.g., Austria and the US is not as visible as in the first plot.

Finally, the last example is a bit harder to understand, but it shows best whether some sort of measure is working. The curve needs to sink drastically, otherwise, the growth is continuing uncontrollibly. 

```{r warning = F, message = F, fig.height=4.5, fig.width = 13}

library(directlabels)

pg1 <- data %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  ggplot(aes(x = days, y = confirmed, group = country)) + 
  geom_line(size = .4, alpha = .7, color = "grey") +
  geom_line(data = . %>% filter(country == "China"), 
            aes(x = days, y = confirmed), colour="#00ace6", size=.8) +
  geom_dl(data = . %>% filter(country == "China"), 
          aes(label = country), color = "#00ace6", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "US"), 
            aes(x = days, y = confirmed), colour="#00b359", size=.8) +
  geom_dl(data = . %>% filter(country == "US"), 
          aes(label = country), color = "#00b359", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Brazil"), 
            aes(x = days, y = confirmed), colour="#ffcc00", size=.8) +
  geom_dl(data = . %>% filter(country == "Brazil"), 
          aes(label = country), color = "#ffcc00", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Italy"), 
            aes(x = days, y = confirmed), colour="#1d1d63", size=.8) +
  geom_dl(data = . %>% filter(country == "Italy"), 
          aes(label = country), color = "#1d1d63", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Germany"), 
            aes(x = days, y = confirmed), colour="#cc0000", size=.8) +
  geom_dl(data = . %>% filter(country == "Germany"), 
          aes(label = country), color = "#cc0000", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Austria"), 
            aes(x = days, y = confirmed), colour="#9e2e9e", size=.8) +
  geom_dl(data = . %>% filter(country == "Austria"), 
          aes(label = country), color = "#9e2e9e", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "United Kingdom"), 
            aes(x = days, y = confirmed), colour="#ff8000", size=.8) +
  geom_dl(data = . %>% filter(country == "United Kingdom"), 
          aes(label = country), color = "#ff8000", method = list(dl.combine("last.points"), cex = .65)) +
  theme_linedraw() +
  xlim(0,140) +
  ylim(0, 1500000) +
  theme(legend.position = "none") +
  labs(x = "days after 100 cases", y = "total cases (limited to 1.000.000)", color = "")

pg2 <- data %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  ggplot(aes(x = days, y = confirmed, group = country)) + 
  geom_line(size = .4, alpha = .7, color = "grey") +
  geom_line(data = . %>% filter(country == "China"), 
            aes(x = days, y = confirmed), colour="#00ace6", size=.8) +
  geom_dl(data = . %>% filter(country == "China"), 
          aes(label = country), color = "#00ace6", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "US"), 
            aes(x = days, y = confirmed), colour="#00b359", size=.8) +
  geom_dl(data = . %>% filter(country == "US"), 
          aes(label = country), color = "#00b359", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Brazil"), 
            aes(x = days, y = confirmed), colour="#ffcc00", size=.8) +
  geom_dl(data = . %>% filter(country == "Brazil"), 
          aes(label = country), color = "#ffcc00", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Italy"), 
            aes(x = days, y = confirmed), colour="#1d1d63", size=.8) +
  geom_dl(data = . %>% filter(country == "Italy"), 
          aes(label = country), color = "#1d1d63", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Germany"), 
            aes(x = days, y = confirmed), colour="#cc0000", size=.8) +
  geom_dl(data = . %>% filter(country == "Germany"), 
          aes(label = country), color = "#cc0000", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Austria"), 
            aes(x = days, y = confirmed), colour="#9e2e9e", size=.8) +
  geom_dl(data = . %>% filter(country == "Austria"), 
          aes(label = country), color = "#9e2e9e", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "United Kingdom"), 
            aes(x = days, y = confirmed), colour="#ff8000", size=.8) +
  geom_dl(data = . %>% filter(country == "United Kingdom"), 
          aes(label = country), color = "#ff8000", method = list(dl.combine("last.points"), cex = .65)) +
  theme_linedraw() +
  scale_y_log10() +
  xlim(0, 140) +
  scale_color_brewer(palette = "Dark2") +
  theme(legend.position = "bottom") +
  labs(x = "days after 100 cases", y = "total cases (log)", color = "")

pg3 <- data %>%
  filter(confirmed >= 1000) %>%
  group_by(country) %>%
  mutate(new_cases = confirmed - lag(confirmed, 7)) %>%
  ungroup %>%
  ggplot(aes(x = confirmed, y = new_cases, group = country)) + 
  geom_line(size = .4, alpha = .7, color = "grey") +
  geom_line(data = . %>% filter(country == "China"), 
            aes(x = confirmed, y = new_cases), colour="#00ace6", size=.8) +
  geom_dl(data = . %>% filter(country == "China"), 
          aes(label = country), color = "#00ace6", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "US"), 
            aes(x = confirmed, y = new_cases), colour="#00b359", size=.8) +
  geom_dl(data = . %>% filter(country == "US"), 
          aes(label = country), color = "#00b359", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Brazil"), 
            aes(x = confirmed, y = new_cases), colour="#ffcc00", size=.8) +
  geom_dl(data = . %>% filter(country == "Brazil"), 
          aes(label = country), color = "#ffcc00", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Italy"), 
            aes(x = confirmed, y = new_cases), colour="#1d1d63", size=.8) +
  geom_dl(data = . %>% filter(country == "Italy"), 
          aes(label = country), color = "#1d1d63", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Germany"), 
            aes(x = confirmed, y = new_cases), colour="#cc0000", size=.8) +
  geom_dl(data = . %>% filter(country == "Germany"), 
          aes(label = country), color = "#cc0000", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "Austria"), 
            aes(x = confirmed, y = new_cases), colour="#9e2e9e", size=.8) +
  geom_dl(data = . %>% filter(country == "Austria"), 
          aes(label = country), color = "#9e2e9e", method = list(dl.combine("last.points"), cex = .65)) +
  geom_line(data = . %>% filter(country == "United Kingdom"), 
            aes(x = confirmed, y = new_cases), colour="#ff8000", size=.8) +
  geom_dl(data = . %>% filter(country == "United Kingdom"), 
          aes(label = country), color = "#ff8000", method = list(dl.combine("last.points"), cex = .65)) +
  scale_x_log10() +
  scale_y_log10() +
  theme_linedraw() +
  scale_color_brewer(palette = "Dark2") +
  theme(legend.position = "none") +
  labs(x = "total cases (log)", y = "new cases (log)", color = "")

cowplot::plot_grid(pg1, pg2, pg3,
                   align = "h",
                   axis = "lbr",
                   ncol = 3)

ggsave("figures/plot_8.png",
       width = 15,
       height = 5.5,
       dpi = 600)


```


#### Daily new cases

Another visualization that is often used is based on changes in daily new cases (here averaged cross one or two weeks). 

##### Europe


```{r, fig.height=9, fig.width = 14}
data %>%
  mutate("one week" = confirmed - lag(confirmed, 7),
         "two weeks" = confirmed - lag(confirmed, 14)) %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  ungroup %>%
  gather(daily_cases, value, "one week", "two weeks") %>%
  filter(country %in% europe) %>%
  ggplot(aes(x = days, y = value, color = daily_cases)) +
  geom_line() +
  scale_color_manual(values = c("#00ace6", "#ff8000")) +
  facet_wrap(~country, scales = "free_y") +
  see::theme_modern() +
  labs(x = "days after 100 cases", y = "number of new cases", color = "new cases")
```


##### America

```{r, , fig.height=7, fig.width = 10.5}
data %>%
  mutate(cases_pd = confirmed - lag(confirmed, 1),
         "one week" = confirmed - lag(confirmed, 7),
         "two weeks" = confirmed - lag(confirmed, 14)) %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  ungroup %>%
  gather(daily_cases, value, "one week", "two weeks") %>%
  filter(country %in% america) %>%
  ggplot(aes(x = days, y = value, color = daily_cases)) +
  geom_line() +
  scale_color_manual(values = c("#00ace6", "#ff8000")) +
  facet_wrap(~country, scales = "free_y") +
  see::theme_modern() +
  labs(x = "days after 100 cases", y = "number of new cases", color = "new cases")
```


##### Middle East

```{r, fig.height=7, fig.width = 10.5}
data %>%
  mutate("one week" = confirmed - lag(confirmed, 7),
         "two weeks" = confirmed - lag(confirmed, 14)) %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  ungroup %>%
  gather(daily_cases, value, "one week", "two weeks") %>%
  filter(country %in% middleeast) %>%
  ggplot(aes(x = days, y = value, color = daily_cases)) +
  geom_line() +
  scale_color_manual(values = c("#00ace6", "#ff8000")) +
  facet_wrap(~country, scales = "free_y") +
  see::theme_modern() +
  labs(x = "days after 100 cases", y = "number of new cases", color = "new cases")
```


##### Asia

```{r, , fig.height=7, fig.width = 11.5}
data %>%
  mutate("one week" = confirmed - lag(confirmed, 7),
         "two weeks" = confirmed - lag(confirmed, 14)) %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  ungroup %>%
  gather(daily_cases, value, "one week", "two weeks") %>%
  filter(country %in% asia) %>%
  ggplot(aes(x = days, y = value, color = daily_cases)) +
  geom_line() +
  scale_color_manual(values = c("#00ace6", "#ff8000")) +
  facet_wrap(~country, scales = "free_y") +
  see::theme_modern() +
  labs(x = "days after 100 cases", y = "number of new cases", color = "new cases")
```

##### Africa

```{r, , fig.height=6, fig.width = 10}
data %>%
  mutate("one week" = confirmed - lag(confirmed, 7),
         "two weeks" = confirmed - lag(confirmed, 14)) %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate(days = 1:n()) %>%
  ungroup %>%
  gather(daily_cases, value, "one week", "two weeks") %>%
  filter(country %in% africa) %>%
  ggplot(aes(x = days, y = value, color = daily_cases)) +
  geom_line() +
  scale_color_manual(values = c("#00ace6", "#ff8000")) +
  facet_wrap(~country, scales = "free_y") +
  see::theme_modern() +
  labs(x = "days after 100 cases", y = "number of new cases", color = "new cases")
```



